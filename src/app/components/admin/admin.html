<div class="admin-page">
  <header class="admin-header">
    <div class="header-content">
      <div class="header-left">
        <div class="logo">
          <img src="assets/church.ico" alt="Church Manager Logo" />
          <span class="logo-text">
            <span class="church">CHURCH</span> <span class="manager">MANAGER</span>
          </span>
        </div>
        <span class="admin-badge">ADMINISTRADOR</span>
      </div>
      <div class="header-right">
        <div class="user-info">
          <div class="user-avatar">
            <span>{{ userName.charAt(0).toUpperCase() }}</span>
          </div>
          <div class="user-details">
            <span class="user-name">{{ userName }}</span>
            <span class="user-email">{{ userEmail }}</span>
          </div>
        </div>
        <button class="btn-logout" (click)="onLogout()">
          <span>Sair</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="admin-content">
    <div class="container">
      <!-- Welcome Section -->
      <section class="welcome-section">
        <h1 class="page-title">Painel de Administra√ß√£o</h1>
        <p class="page-subtitle">Gerencie todos os eventos da igreja</p>
      </section>

      <!-- Events Section -->
      <section class="events-section">
        <div class="section-header">
          <h2 class="section-title">Todos os Eventos</h2>
          <div class="section-actions">
            <button class="btn-create" (click)="openCreateModal()">
              <span>‚ûï Criar Novo Evento</span>
            </button>
          </div>
        </div>

        <!-- Loading State -->
        @if (isLoading) {
        <div class="loading-container">
          <div class="loading-spinner-large"></div>
          <p>Carregando eventos...</p>
        </div>
        }

        <!-- Error State -->
        @if (errorMessage && !isLoading) {
        <div class="error-container">
          <div class="error-icon">‚ö†Ô∏è</div>
          <p class="error-text">{{ errorMessage }}</p>
          <button class="btn-retry" (click)="loadAllEvents()">Tentar Novamente</button>
        </div>
        }

        <!-- Empty State -->
        @if (!isLoading && !errorMessage && events.length === 0) {
        <div class="empty-state">
          <div class="empty-icon">üìÖ</div>
          <h3 class="empty-title">Nenhum evento cadastrado</h3>
          <p class="empty-text">Clique em "Criar Novo Evento" para adicionar o primeiro evento.</p>
        </div>
        }

        <!-- Events Grid -->
        @if (!isLoading && !errorMessage && events.length > 0) {
        <div class="events-grid">
          @for (event of events; track event.id) {
          <div class="event-card">
            <div class="event-header">
              <div class="event-date-badge">
                <span class="day">{{ formatDate(event.date).split(' ')[0] }}</span>
                <span class="month">{{ formatDate(event.date).split(' ')[2] }}</span>
              </div>
              <div class="event-status" [ngClass]="getEventStatusClass(event.status)">
                {{ getEventStatusText(event.status) }}
              </div>
            </div>

            <div class="event-body">
              <h3 class="event-title">{{ event.title }}</h3>
              <p class="event-description">{{ event.description }}</p>

              <div class="event-details">
                <div class="event-detail">
                  <span class="detail-icon">üìç</span>
                  <span class="detail-text">{{ event.location }}</span>
                </div>
                <div class="event-detail">
                  <span class="detail-icon">üïê</span>
                  <span class="detail-text">{{ formatTime(event.date) }}</span>
                </div>
                <div class="event-detail">
                  <span class="detail-icon">üë•</span>
                  <span class="detail-text">{{ event.participants }} participantes</span>
                </div>
              </div>
            </div>

            <div class="event-footer">
              <button class="btn-event-details" (click)="openDetailsModal(event)" title="Ver detalhes">
                üëÅÔ∏è Detalhes
              </button>
              <button class="btn-event-participants" (click)="openAddParticipantModal(event)" title="Adicionar participantes">
                üë§ Adicionar
              </button>
              <button class="btn-event-edit" (click)="openEditModal(event)" title="Editar evento">
                ‚úèÔ∏è Editar
              </button>
              <button class="btn-event-delete" (click)="openDeleteConfirm(event)" title="Excluir evento">
                üóëÔ∏è Excluir
              </button>
            </div>
          </div>
          }
        </div>
        }
      </section>

    </div>
  </main>

  <!-- Modal Criar Evento -->
  @if (showCreateModal) {
  <div class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">‚ûï Criar Novo Evento</h2>
        <button class="btn-close-modal" (click)="closeCreateModal()">‚úï</button>
      </div>

      <form [formGroup]="createEventForm" (ngSubmit)="onSubmitCreate()" class="modal-body">
        <!-- caso de sucesso -->
        @if (successMessage) {
        <div class="success-message">
          ‚úÖ {{ successMessage }}
        </div>
        }

        <!-- caso de erro -->
        @if (errorMessage) {
        <div class="error-message">
          ‚ùå {{ errorMessage }}
        </div>
        }

        <div class="form-group">
          <label for="name" class="form-label">Nome do Evento *</label>
          <input
            type="text"
            id="name"
            formControlName="name"
            class="form-input"
            placeholder="Ex: Culto Dominical"
            [class.input-error]="name?.invalid && name?.touched"
          />
          @if (name?.invalid && name?.touched) {
          <span class="error-text">
            @if (name?.errors?.['required']) { Nome √© obrigat√≥rio }
            @if (name?.errors?.['minlength']) { Nome deve ter no m√≠nimo 3 caracteres }
          </span>
          }
        </div>

        <!-- Descri√ß√£o -->
        <div class="form-group">
          <label for="description" class="form-label">Descri√ß√£o *</label>
          <textarea
            id="description"
            formControlName="description"
            class="form-textarea"
            placeholder="Descreva o evento..."
            rows="3"
            [class.input-error]="description?.invalid && description?.touched"
          ></textarea>
          @if (description?.invalid && description?.touched) {
          <span class="error-text">
            @if (description?.errors?.['required']) { Descri√ß√£o √© obrigat√≥ria }
            @if (description?.errors?.['minlength']) { Descri√ß√£o deve ter no m√≠nimo 10 caracteres }
          </span>
          }
        </div>

        <!-- Data/Hora In√≠cio -->
        <div class="form-group">
          <label for="startDatetime" class="form-label">Data/Hora de In√≠cio *</label>
          <input
            type="datetime-local"
            id="startDatetime"
            formControlName="startDatetime"
            class="form-input"
            [class.input-error]="startDatetime?.invalid && startDatetime?.touched"
          />
          @if (startDatetime?.invalid && startDatetime?.touched) {
          <span class="error-text">Data/hora de in√≠cio √© obrigat√≥ria</span>
          }
        </div>

        <!-- Data/Hora Fim -->
        <div class="form-group">
          <label for="endDatetime" class="form-label">Data/Hora de T√©rmino *</label>
          <input
            type="datetime-local"
            id="endDatetime"
            formControlName="endDatetime"
            class="form-input"
            [class.input-error]="endDatetime?.invalid && endDatetime?.touched"
          />
          @if (endDatetime?.invalid && endDatetime?.touched) {
          <span class="error-text">Data/hora de t√©rmino √© obrigat√≥ria</span>
          }
        </div>

        <!-- Local -->
        <div class="form-group">
          <label for="location" class="form-label">Local *</label>
          <input
            type="text"
            id="location"
            formControlName="location"
            class="form-input"
            placeholder="Ex: Igreja Central"
            [class.input-error]="location?.invalid && location?.touched"
          />
          @if (location?.invalid && location?.touched) {
          <span class="error-text">Local √© obrigat√≥rio</span>
          }
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn-cancel"
            (click)="closeCreateModal()"
            [disabled]="isSubmitting"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn-submit"
            [disabled]="isSubmitting || createEventForm.invalid"
          >
            @if (isSubmitting) {
              <span>Criando...</span>
            } @else {
              <span>Criar Evento</span>
            }
          </button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Modal Editar Evento -->
  @if (showEditModal) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">‚úèÔ∏è Editar Evento</h2>
        <button class="btn-close-modal" (click)="closeEditModal()">‚úï</button>
      </div>

      <form [formGroup]="editEventForm" (ngSubmit)="onSubmitEdit()" class="modal-body">
        <!-- caso de sucesso -->
        @if (successMessage) {
        <div class="success-message">
          ‚úÖ {{ successMessage }}
        </div>
        }

        <!-- caso de erro -->
        @if (errorMessage) {
        <div class="error-message">
          ‚ùå {{ errorMessage }}
        </div>
        }

        <!-- Nome do Evento -->
        <div class="form-group">
          <label for="editName" class="form-label">Nome do Evento *</label>
          <input
            type="text"
            id="editName"
            formControlName="name"
            class="form-input"
            placeholder="Ex: Culto Dominical"
            [class.input-error]="editName?.invalid && editName?.touched"
          />
          @if (editName?.invalid && editName?.touched) {
          <span class="error-text">
            @if (editName?.errors?.['required']) { Nome √© obrigat√≥rio }
            @if (editName?.errors?.['minlength']) { Nome deve ter no m√≠nimo 3 caracteres }
          </span>
          }
        </div>

        <!-- Descri√ß√£o -->
        <div class="form-group">
          <label for="editDescription" class="form-label">Descri√ß√£o *</label>
          <textarea
            id="editDescription"
            formControlName="description"
            class="form-textarea"
            placeholder="Descreva o evento..."
            rows="3"
            [class.input-error]="editDescription?.invalid && editDescription?.touched"
          ></textarea>
          @if (editDescription?.invalid && editDescription?.touched) {
          <span class="error-text">
            @if (editDescription?.errors?.['required']) { Descri√ß√£o √© obrigat√≥ria }
            @if (editDescription?.errors?.['minlength']) { Descri√ß√£o deve ter no m√≠nimo 10 caracteres }
          </span>
          }
        </div>

        <!-- Data/Hora In√≠cio -->
        <div class="form-group">
          <label for="editStartDatetime" class="form-label">Data/Hora de In√≠cio *</label>
          <input
            type="datetime-local"
            id="editStartDatetime"
            formControlName="startDatetime"
            class="form-input"
            [class.input-error]="editStartDatetime?.invalid && editStartDatetime?.touched"
          />
          @if (editStartDatetime?.invalid && editStartDatetime?.touched) {
          <span class="error-text">Data/hora de in√≠cio √© obrigat√≥ria</span>
          }
        </div>

        <!-- Data/Hora Fim -->
        <div class="form-group">
          <label for="editEndDatetime" class="form-label">Data/Hora de T√©rmino *</label>
          <input
            type="datetime-local"
            id="editEndDatetime"
            formControlName="endDatetime"
            class="form-input"
            [class.input-error]="editEndDatetime?.invalid && editEndDatetime?.touched"
          />
          @if (editEndDatetime?.invalid && editEndDatetime?.touched) {
          <span class="error-text">Data/hora de t√©rmino √© obrigat√≥ria</span>
          }
        </div>

        <!-- Local -->
        <div class="form-group">
          <label for="editLocation" class="form-label">Local *</label>
          <input
            type="text"
            id="editLocation"
            formControlName="location"
            class="form-input"
            placeholder="Ex: Igreja Central"
            [class.input-error]="editLocation?.invalid && editLocation?.touched"
          />
          @if (editLocation?.invalid && editLocation?.touched) {
          <span class="error-text">Local √© obrigat√≥rio</span>
          }
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn-cancel"
            (click)="closeEditModal()"
            [disabled]="isSubmitting"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn-submit"
            [disabled]="isSubmitting || editEventForm.invalid"
          >
            @if (isSubmitting) {
              <span>Atualizando...</span>
            } @else {
              <span>Atualizar Evento</span>
            }
          </button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Modal Confirmar Exclus√£o -->
  @if (showDeleteConfirm) {
  <div class="modal-overlay" (click)="closeDeleteConfirm()">
    <div class="modal-container modal-small" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">üóëÔ∏è Confirmar Exclus√£o</h2>
        <button class="btn-close-modal" (click)="closeDeleteConfirm()">‚úï</button>
      </div>

      <div class="modal-body">
        <!-- caso de erro -->
        @if (errorMessage) {
        <div class="error-message">
          ‚ùå {{ errorMessage }}
        </div>
        }

        <p class="delete-message">
          Tem certeza que deseja excluir o evento <strong>{{ eventToDelete?.title }}</strong>?
        </p>
        <p class="delete-warning">
          ‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita.
        </p>

        <div class="modal-footer">
          <button
            type="button"
            class="btn-cancel"
            (click)="closeDeleteConfirm()"
            [disabled]="isSubmitting"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="btn-delete-confirm"
            (click)="confirmDelete()"
            [disabled]="isSubmitting"
          >
            @if (isSubmitting) {
              <span>Excluindo...</span>
            } @else {
              <span>Sim, Excluir</span>
            }
          </button>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Modal Adicionar Participante -->
  @if (showAddParticipantModal) {
  <div class="modal-overlay" (click)="closeAddParticipantModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">üë• Adicionar Participantes</h2>
        <button class="btn-close-modal" (click)="closeAddParticipantModal()">‚úï</button>
      </div>

      <form [formGroup]="addParticipantForm" (ngSubmit)="onSubmitAddParticipant()" class="modal-body">
        <!-- Caso de sucesso -->
        @if (successMessage) {
        <div class="success-message">
          ‚úÖ {{ successMessage }}
        </div>
        }

        <!-- Caso de erro -->
        @if (errorMessage) {
        <div class="error-message">
          ‚ùå {{ errorMessage }}
        </div>
        }

        <!-- Evento Info -->
        @if (selectedEventForParticipant) {
        <div class="event-info-box">
          <h3>{{ selectedEventForParticipant.title }}</h3>
          <p>üìç {{ selectedEventForParticipant.location }}</p>
          <p>üìÖ {{ formatDate(selectedEventForParticipant.date) }}</p>
          <p>üë• {{ selectedEventForParticipant.participants }} participantes atuais</p>
        </div>
        }

        <!-- Loading Members -->
        @if (isLoadingMembers) {
        <div class="loading-members">
          <span class="loading-spinner-small"></span>
          <span>Carregando membros...</span>
        </div>
        }

        <!-- Lista de Participantes -->
        @if (!isLoadingMembers) {
        <div formArrayName="participants" class="participants-list">
          @for (participant of participants.controls; track $index) {
            <div [formGroupName]="$index" class="participant-row">
              <div class="row-number">
                <span class="participant-badge">#{{ $index + 1 }}</span>
              </div>

              <div class="participant-fields">
                <!-- Select de Membro -->
                <div class="form-group">
                  <label [for]="'memberId-' + $index" class="form-label">Membro *</label>
                  <select
                    [id]="'memberId-' + $index"
                    formControlName="memberId"
                    class="form-select"
                    [class.invalid]="participants.at($index).get('memberId')?.invalid && participants.at($index).get('memberId')?.touched"
                  >
                    <option value="" disabled>Selecione um membro</option>
                    @for (member of churchMembers; track member.id) {
                      <option [value]="member.id">{{ member.name }}</option>
                    }
                  </select>
                  @if (participants.at($index).get('memberId')?.invalid && participants.at($index).get('memberId')?.touched) {
                    <div class="form-error">
                      <span>Selecione um membro</span>
                    </div>
                  }
                </div>

                <!-- Fun√ß√£o/Role -->
                <div class="form-group">
                  <label [for]="'role-' + $index" class="form-label">Fun√ß√£o *</label>
                  <select
                    [id]="'role-' + $index"
                    formControlName="role"
                    class="form-select"
                    [class.invalid]="participants.at($index).get('role')?.invalid && participants.at($index).get('role')?.touched"
                  >
                    <option value="PARTICIPANT">Participante</option>
                    <option value="ORGANIZER">Organizador</option>
                    <option value="VOLUNTEER">Volunt√°rio</option>
                    <option value="SPEAKER">Palestrante</option>
                    <option value="COORDINATOR">Coordenador</option>
                  </select>
                </div>
              </div>

              <div class="row-actions">
                @if (participants.length > 1) {
                  <button
                    type="button"
                    class="btn-remove-row"
                    (click)="removeParticipantRow($index)"
                    [disabled]="isSubmitting"
                    title="Remover participante"
                  >
                    üóëÔ∏è
                  </button>
                }
              </div>
            </div>
          }
        </div>

        <!-- Bot√£o Adicionar Mais -->
        <div class="add-more-section">
          <button
            type="button"
            class="btn-add-more"
            (click)="addParticipantRow()"
            [disabled]="isSubmitting"
          >
            <span>‚ûï Adicionar Outro Participante</span>
          </button>
        </div>

        <div class="participants-summary">
          <span>Total de participantes a adicionar: <strong>{{ participants.length }}</strong></span>
        </div>
        }

        <!-- Bot√µes de A√ß√£o -->
        <div class="modal-footer">
          <button
            type="button"
            class="btn-cancel"
            (click)="closeAddParticipantModal()"
            [disabled]="isSubmitting"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn-submit"
            [disabled]="isSubmitting || addParticipantForm.invalid"
          >
            @if (isSubmitting) {
              <span class="loading-spinner-small"></span>
              <span>Adicionando...</span>
            } @else {
              <span>Adicionar {{ participants.length }} Participante{{ participants.length > 1 ? 's' : '' }}</span>
            }
          </button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Modal Detalhes do Evento -->
  @if (showDetailsModal) {
  <div class="modal-overlay" (click)="closeDetailsModal()">
    <div class="modal-container modal-details" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">üìã Detalhes do Evento</h2>
        <button class="btn-close-modal" (click)="closeDetailsModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <!-- Caso de erro -->
        @if (errorMessage) {
        <div class="error-message">
          ‚ùå {{ errorMessage }}
        </div>
        }

        <!-- Loading
        @if (isLoadingDetails) {
        <div class="loading-details">
          <span class="loading-spinner-large"></span>
          <p>Carregando detalhes...</p>
        </div>
        } -->

        <!-- Conte√∫do dos Detalhes -->
        @if (selectedEventDetails) {
        <!-- Informa√ß√µes Gerais -->
        <div class="details-section">
          <h3 class="details-section-title">üìå Informa√ß√µes Gerais</h3>
          <div class="details-info-grid">
            <div class="info-item">
              <span class="info-label">Nome:</span>
              <span class="info-value">{{ selectedEventDetails.name }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Local:</span>
              <span class="info-value">{{ selectedEventDetails.location }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">In√≠cio:</span>
              <span class="info-value">{{ formatDate(selectedEventDetails.startDatetime) }} √†s {{ formatTime(selectedEventDetails.startDatetime) }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">T√©rmino:</span>
              <span class="info-value">{{ formatDate(selectedEventDetails.endDatetime) }} √†s {{ formatTime(selectedEventDetails.endDatetime) }}</span>
            </div>
            <div class="info-item full-width">
              <span class="info-label">Descri√ß√£o:</span>
              <span class="info-value">{{ selectedEventDetails.description }}</span>
            </div>
          </div>
        </div>

        <!-- Participantes -->
        <div class="details-section">
          <h3 class="details-section-title">üë• Participantes ({{ selectedEventDetails.participants.length }})</h3>

          @if (selectedEventDetails.participants.length === 0) {
          <div class="empty-list">
            <p>Nenhum participante cadastrado ainda.</p>
          </div>
          } @else {
          <div class="participants-table">
            <div class="table-header">
              <div class="table-cell">#</div>
              <div class="table-cell">ID</div>
              <div class="table-cell">Fun√ß√£o</div>
              <div class="table-cell">Registrado em</div>
            </div>
            @for (participant of selectedEventDetails.participants; track participant.id; let i = $index) {
            <div class="table-row">
              <div class="table-cell">{{ i + 1 }}</div>
              <div class="table-cell">{{ participant.memberId }}</div>
              <div class="table-cell">
                <span class="role-badge role-{{ participant.role.toLowerCase() }}">
                  {{ getRoleLabel(participant.role) }}
                </span>
              </div>
              <div class="table-cell">{{ formatDate(participant.registeredAt) }}</div>
            </div>
            }
          </div>
          }
        </div>
        }
      </div>

      <!-- Footer do Modal -->
      <div class="modal-footer">
        <button
          type="button"
          class="btn-cancel"
          (click)="closeDetailsModal()"
        >
          Fechar
        </button>
      </div>
    </div>
  </div>
  }
</div>
